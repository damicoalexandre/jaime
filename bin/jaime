#!/usr/bin/env bash

set -e

# Prepare cache directory for plugins
export JAIME_CACHE_DIR=${XDG_DATA_HOME:-$HOME/.local/share}/jaime/cache
mkdir -p $JAIME_CACHE_DIR

# List commands and filter through fzf
IFS=: paths=($PATH)

shopt -s nullglob

command="$({
  for path in "${paths[@]}"; do
    for plugin in "${path}/jaime-"*; do
      echo "${plugin##*jaime-}"
    done
  done
}| sort | uniq | fzf --preview='jaime-{} preview')"

# Run command
cmd="jaime-${command}"
output=$(${cmd})
chain=()

for (( ; ; )); do
  if [ -z "$output" ]; then
    "${cmd}" run "${chain[@]}"
    break
  else
    preview="${cmd} preview ${chain[@]} {}"
    argument=$(echo "$output" | fzf --preview="$preview")
    chain+=("$argument")
    output=$("${cmd}" "${chain[@]}")
  fi
done
