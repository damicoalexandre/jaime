#!/usr/bin/env bash

set -e

resolve_link() {
  $(type -p greadlink readlink | head -1) "$1"
}

abs_dirname() {
  local cwd="$(pwd)"
  local path="$1"

  while [ -n "$path" ]; do
    cd "${path%/*}"
    local name="${path##*/}"
    path="$(resolve_link "$name" || true)"
  done

  pwd
  cd "$cwd"
}

export JAIME_CACHE_DIR=${XDG_DATA_HOME:-$HOME/.local/share/jaime/cache}
mkdir -p $JAIME_CACHE_DIR

bin_path="$(abs_dirname "$0")"

command="$({
  for plugin in "${bin_path}/jaime-"*; do
    echo "${plugin##*jaime-}"
  done
} | fzf --bind=space:accept)"

output=$("${bin_path}/jaime-${command}")

if [ -z "$output" ]; then
  "${bin_path}/jaime-${command}" run
else
  echo "$output" | fzf --bind=space:accept | xargs "${bin_path}/jaime-${command}"
fi

