#!/usr/bin/env bash

set -e

# Prepare cache directory for plugins
export JAIME_CACHE_DIR=${XDG_DATA_HOME:-$HOME/.local/share/jaime/cache}
mkdir -p $JAIME_CACHE_DIR

# List commands and filter through fzf
IFS=: paths=($PATH)

shopt -s nullglob

command="$({
  for path in "${paths[@]}"; do
    for plugin in "${path}/jaime-"*; do
      echo "${plugin##*jaime-}"
    done
  done
}| sort | uniq | fzf --bind=space:accept --preview='jaime-{} preview')"

# Run command
output=$("jaime-${command}")

if [ -z "$output" ]; then
  "jaime-${command}" run
else
  echo "$output" | fzf --bind=space:accept --preview="jaime-${command} preview {}" | xargs "jaime-${command}" run
fi
