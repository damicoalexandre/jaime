#!/usr/bin/env bash

set -e

command="$1"

refresh_repos() {
  rm -f $JAIME_CACHE_DIR/github-repos.txt

  declare -i page
  local page=1

  for (( ; ; )); do
    repos=($(curl -u $GITHUB_USER:$GITHUB_TOKEN -s "https://api.github.com/user/repos?per_page=100&page=$page" | jq -r "map(.full_name) | .[]"))

    # Stop if page is empty
    if [ ${#repos[@]} -eq 0 ]; then
      break
    fi

    # Print repo name
    for repo in "${repos[@]}"; do
      echo $repo >> $JAIME_CACHE_DIR/github-repos.txt
    done

    # Go to next page
    ((page+=1))
  done
}

print_repos() {
  if [ -a $JAIME_CACHE_DIR/github-repos.txt ]; then
    cat $JAIME_CACHE_DIR/github-repos.txt
  fi
}

print_preview() {
  local command="$1"

  if [[ "$command" = "refresh" ]]; then
    echo "Refresh local repository cache"
  else
    echo "Open this repository"
  fi
}

if [ -z "$command" ]; then
  echo "refresh"
  print_repos
  exit
fi

if [[ "$command" = "preview" ]]; then
  shift
  if [ -z "$1" ]; then
    echo "Open github repository in the browser"
  else
    print_preview "$1"
  fi
  exit
fi

if [[ "$command" = "run" ]]; then
  shift
  arg="$1"

  if [[ "$arg" = "refresh" ]]; then
    refresh_repos
    exit
  fi

  repo_url="https://github.com/${arg}"

  open "${repo_url}"
fi
